@model IEnumerable<ECOMM.Core.Models.SubCategory>

@{
    ViewData["Title"] = "Alt Kategoriler";
}

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<div class="container mt-4">
    <h2>Alt Kategoriler</h2>
    <button class="btn btn-primary" data-toggle="modal" data-target="#subCategoryModal">Yeni Alt Kategori Ekle</button>
    <table id="subCategoryTable" class="table table-striped mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Alt Kategori Adı</th>
                <th>Açıklama</th>
                <th>İşlemler</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var subCategory in Model)
            {
                <tr>
                    <td>@subCategory.Id</td>
                    <td>@subCategory.SubCatName</td>
                    <td>@subCategory.ParentCategoryDescription</td>
                    <td>
                        <button class="btn btn-warning editSubCategory" data-id="@subCategory.Id">Düzenle</button>
                        <button class="btn btn-danger deleteSubCategory" data-id="@subCategory.Id">Sil</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="subCategoryModal" tabindex="-1" role="dialog" aria-labelledby="subCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="subCategoryModalLabel">Alt Kategori Ekle/Güncelle</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="subCategoryId" />
                <div class="form-group">
                    <label for="subCategoryName">Alt Kategori Adı</label>
                    <input type="text" class="form-control" id="subCategoryName" />
                    <span id="subCategoryName-error" class="text-danger" style="display:none;">Lütfen alt kategori adını girin.</span>
                </div>
                <div class="form-group">
                    <label for="subCategoryDescription">Açıklama</label>
                    <textarea class="form-control" id="subCategoryDescription"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" id="btnSaveSub">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        // DataTable'ı başlat
        $('#subCategoryTable').DataTable();

        // Alt kategori ekleme ve güncelleme işlemi
        $('#btnSaveSub').click(function () {
            const subCategory = {
                Id: $("#subCategoryId").val(),
                SubCatName: $("#subCategoryName").val(),
                ParentCategoryDescription: $("#subCategoryDescription").val(),
            };

            if (!subCategory.SubCatName) {
                $("#subCategoryName-error").show();
                return;
            }

            const url = subCategory.Id ? '/Category/UpdateSubCategory' : '/Category/AddSubCategory';
            $.ajax({
                type: 'POST',
                url: url,
                contentType: 'application/json',
                data: JSON.stringify(subCategory),
                success: function () {
                    alert("Alt kategori başarıyla " + (subCategory.Id ? "güncellendi." : "eklendi."));
                    location.reload(); // Sayfayı yenile
                },
                error: function (xhr) {
                    alert("Bir hata oluştu: " + xhr.responseText);
                }
            });
        });

        // Alt kategori düzenleme işlemi
        $(document).on('click', '.editSubCategory', function () {
            const id = $(this).data('id');
            // AJAX isteği ile alt kategori verilerini al
            $.ajax({
                type: 'GET',
                url: `/Category/GetById/${id}`,
                success: function (subCategory) {
                    $("#subCategoryId").val(subCategory.id);
                    $("#subCategoryName").val(subCategory.subCatName);
                    $("#subCategoryDescription").val(subCategory.parentCategoryDescription);
                    $('#subCategoryModal').modal('show');
                }
            });
        });

        // Alt kategori silme işlemi
        $(document).on('click', '.deleteSubCategory', function () {
            const id = $(this).data('id');
            if (confirm("Bu alt kategoriyi silmek istediğinize emin misiniz?")) {
                $.ajax({
                    type: 'POST',
                    url: `/Category/DeleteSubCategory/${id}`,
                    success: function () {
                        alert("Alt kategori başarıyla silindi.");
                        location.reload(); // Sayfayı yenile
                    },
                    error: function (xhr) {
                        alert("Bir hata oluştu: " + xhr.responseText);
                    }
                });
            }
        });
    });
</script>
